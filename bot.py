from scholarly import scholarly
from pyrogram import Client, filters
from pyrogram.enums import ParseMode
import random
import google.generativeai as genai
import os

bot_token = os.environ['BOT_TOKEN']
api_hash = os.environ['API_HASH']
api_id = os.environ['API_ID']
# ...
open_token = os.environ['OPENAI_TOKEN']

TARGET = 'DiaraToken'

app = Client(
    "my_bot",
    api_id=api_id, api_hash=api_hash,
    bot_token=bot_token
)

genai.configure(api_key=open_token)

def welcome():
    keywords = [
            "Biomaterials",
            "Bioinformatics",
            "Biomedical Imaging",
            "Biomimetics",
            "Tissue Engineering",
            "Medical Devices",
            "Neuroengineering",
            "Biosensors",
            "Bioprinting",
            "Clinical Engineering",
            "Rehabilitation Engineering",
            "Bioelectrics",
            "Biomechanics",
            "Nanomedicine",
            "Regenerative Medicine",
            "Biomedical Signal Processing",
            "Genetic Engineering",
            "Pharmacokinetics",
            "Medical Robotics",
            "Wearable Health Technology",
            "Telemedicine",
            "Cardiovascular Engineering",
            "Orthopaedic Bioengineering",
            "Prosthetics and Implants",
            "Biochemical Engineering",
            "Optical Imaging",
            "Molecular Imaging",
            "Artificial Organs",
            "Cancer Bioengineering",
            "Human-Computer Interaction in Healthcare"
        ]

    selected_keyword = random.choice(keywords)
    search_query = scholarly.search_pubs(selected_keyword)
    articles = [next(search_query) for _ in range(5)]
    random_article = random.choice(articles)

    abstract = random_article['bib'].get('abstract', 'No abstract available')


    RESUKLT = f"Title: **{random_article['bib']['title']}**\n\n" \
            f"Abstract: {abstract}\n\n" \
            f"Author(s): **{random_article['bib']['author']}**\n\n" \
            f"Year: {random_article['bib']['pub_year']}\n" \
            f"Link: {random_article['pub_url']}\n\n" \
            "ğŸ¥‡ This message was generated by **[DiaraColab search engine](https://github.com/Mehranalam/Diara-Colab)** and the articles were received from google scholar.\n\n" \
            "**ğŸŒŠ ØªÙ…Ø§Ù… Ù…Ù‚Ø§Ù„Ø§Øª Ø§Ø±Ø³Ø§Ù„ÛŒ ØªÙˆØ³Ø· Ø±Ø¨Ø§Øª Ø¯Ø§Ø®Ù„ Ú©Ø§Ù†Ø§Ù„ @DiaraToken Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ØªØ± Ø¢Ø±Ø´ÛŒÙˆ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.**"
    
    return RESUKLT


def mind(result):
    model = genai.GenerativeModel("gemini-1.5-flash")
    content = f"""Ù„Ø·ÙØ§ Ø§ÛŒÙ† Ù…Ù‚Ø§Ù„Ù‡ Ø±Ùˆ Ø¨Ù‡ Ø´Ú©Ù„ Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨ Ùˆ Ø¨Ø§ Ø¬Ø²ÙŠÛŒØ§Øª Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù† Ùˆ Ø¨Ø±Ø¯Ø§Ø´Øª Ù‡Ø§Øª Ø±Ùˆ Ø¨Ù‡ Ø´Ú©Ù„ Ø²Ø¨Ø§Ù† Ø¹Ø§Ù…ÛŒØ§Ù†Ù‡ ÙØ§Ø±Ø³ÛŒ Ø¨Ù‡â€ŒØ·ÙˆØ± Ú©Ø§Ù…Ù„ Ø´Ø±Ø­ Ø¨Ø¯Ù‡ Ø¨Ø·ÙˆØ± Ø¹Ù„Ù…ÛŒ Ùˆ Ø¯Ù‚ÛŒÙ‚ Ø¨Ø§ ÙØ±Ù…ÙˆÙ„Ù‡Ø§ Ùˆ Ø¯Ù„Ø§ÛŒÙ„ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ùˆ Ø¯Ù‚ÛŒÙ‚Ø§ ØªÙˆØ¶ÛŒØ­ Ø¨Ø¯Ù‡ Ø§ÛŒÙ† Ù…Ù‚Ø§Ù„Ù‡ Ø±Ùˆ.

Ù„ÛŒÙ†Ú© Ù…Ù‚Ø§Ù„Ù‡ Ùˆ Ø®Ù„Ø§ØµÙ‡â€ŒØ§ÛŒ Ø§Ø²Ø´: {result}

Ù„Ø·ÙØ§ Ø§Ù†ØªÙ‡Ø§ÛŒ Ù¾Ø³Øª Ù‡Ù… Ø±ÙØ±Ù†Ø³ Ø¨Ø²Ø§Ø± Ùˆ Ø§Ø±Ø¬Ø§Ø¹ Ø¨Ø¯Ù‡.
Ø§Ú¯Ù‡ Ù‡Ù… ÙØ§ÛŒÙ„ PDF Ø¨ÙˆØ¯ Ùˆ Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø¯Ø§Ø´ØªÛŒ ÛŒÚ© Ø®Ø¨Ø± Ø¯Ø±Ù…ÙˆØ±Ø¯ Ù…Ù‡Ù†Ø¯Ø³ÛŒ Ù¾Ø²Ø´Ú©ÛŒ Ø¨ÙØ±Ø³Øª ÛŒÙ‡ Ø®Ø¨Ø± Ø¹Ù„Ù…ÛŒ
"""
    response = model.generate_content(content)

    rtl = response.text
    uio = rtl.replace("#", "")
    
    return uio

def news():
    model = genai.GenerativeModel("gemini-1.5-flash")
    content = f"ÛŒÚ© Ø®Ø¨Ø± Ø¯Ø±Ù…ÙˆØ±Ø¯ Ù…Ù‡Ù†Ø¯Ø³ÛŒ Ù¾Ø²Ø´Ú©ÛŒ Ø¨ÙØ±Ø³Øª ÛŒÙ‡ Ø®Ø¨Ø± Ø¹Ù„Ù…ÛŒ Ùˆ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ù…ÛŒØ®ÙˆØ§Ù… Ø¨Ø¯ÙˆÙ†Ù… Ø§Ù„Ø§Ù† Ù…Ù‡Ù†Ø¯Ø³ÛŒ Ù¾Ø²Ø´Ú©ÛŒ Ø¯Ø± Ø¯Ù†ÛŒØ§ Ú†Ù‡ Ù¾ÛŒØ´Ø±ÙØªÛŒ Ú©Ø±Ø¯Ù‡ Ùˆ Ù…Ù† Ø¹Ù‚Ø¨ Ù†Ù…ÙˆÙ†Ù…"
    response = model.generate_content(content)

    rtl = response.text
    uio = rtl.replace("#", "")
    
    return uio


try:
    resukt = welcome()
    maintain = mind(resukt)
    n = news()
except:
    print("again! :))")
    resukt = welcome()
    maintain = mind(resukt)
    n = news()

async def main():
    async with app:
        sent_message = await (app.send_message(TARGET ,resukt, disable_web_page_preview=True, parse_mode=ParseMode.MARKDOWN))
        sent_message = await (app.send_message(n ,resukt, disable_web_page_preview=True, parse_mode=ParseMode.MARKDOWN))
        await app.send_message(TARGET ,maintain , reply_to_message_id=sent_message.id)

app.run(main())
